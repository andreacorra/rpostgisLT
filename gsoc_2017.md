The `rpostgisLT` package started as Google Summer of Code (GSoC) project in 2016. The following page summarizes my experience as GSoC student and main developer during the GSoC 2017.

Mentoring organization of the Google Summer of Code 2016: **R project for statistical computing**

Mentors:
 
 + Mathieu Basille (basille@ufl.edu)
 + David Bucklin (dbucklin@ufl.edu)
 + Clément Calenge (clement.calenge@oncfs.gouv.fr)

Developer: Balázs Dukai (balazs.dukai@gmail.com)

During GSoC 2017 the package has been mainly developed by me and the [release v0.6.0]() shows the final outcome of this development period.

The main outcome of GSoC 2017 is the `explorePgtraj`function which wraps a *Shiny* app. There are several functions that support the operation of this app and they are stored in the `utils-shiny.R`, `createShinyViews.R` scripts. Additionally, I sanitized the unit tests with the `testthat` package and included two continuous integration services ([Travis CI](https://travis-ci.org/mablab/rpostgisLT) and [AppVeyor](https://ci.appveyor.com/project/balazsdukai/rpostgislt)). In the section *The MoSCoW deliverables* below, those elements are ticked that I completed.

![The `explorePgtraj` app](https://github.com/mablab/rpostgisLT/blob/master/vignettes/fig/explorePgtraj.png)

## About me
My name is Balázs Dukai and currently I am a student of the [MSc Geomatics](http://geomatics.tudelft.nl/) program at the Delft University of Technology. However I took a bit of a detour before eventually ending up in the field of geomatics. First I studied and practiced landscape architecture, then I did several courses on data science and programming with R being the first scripting language I have learnt. After having some exposure to geographical information systems (GIS) and land surveying I decided to pursue the career of spatial data acquisition, management and analysis.

After a successful GSoC 2016 we stayed in touch with the project mentors. We kept developing the package and started collaborating on scientific articles that showcase its use. While in 2016 we focused on data storage and management, it was clear that the package need a front-end that allows the user to interactively explore trajectories. After some discussion we decided that a second round of GSoC would greatly boost the development thus we gave it a go.

## The project plan and workflow

The [project proposal](https://github.com/rstats-gsoc/gsoc2017/wiki/Interactive-trajectory-tool-in-rpostgisLT) defines that the expected output is a functional interactive trajectory viewer fully integrated with `rpostgisLT` to create, edit, and analyze/explore `pgtraj`. This tool is expected to:

* have an interactive map which can load spatial data into the map from the database, or the current data environment
* create `pgtraj` from loaded data sets/database tables
* edit `pgtraj` (cut trajectories into bursts, remove/add locations or steps, filter trajectories according to step attributes)
* analyze `pgtraj` trajectory with step-by-step control (as in `adehabitatLT::trajdyn`), providing step attribute information (length, time, angle, etc)
* load and animate one to many `pgtraj` simultaneously
* extract data from other spatial data sets (points, polygons, lines, rasters) to trajectories and add it to `pgtraj` 'infolocs'

As the first step, I asked my mentors to translate the above expectations into [must, should, could, won't](https://en.wikipedia.org/wiki/MoSCoW_method) deliverables. This approach helped tremendously in achieving a common understanding and focusing my efforts.

### The MoSCoW deliverables

#### Must
1. [ ] Interactive editing of the infolocs of trajectories, by clicking on the trajectory and manually editing the desired field in the dedicated Infolocs GUI section.
2. [x] Display a single trajectory, entirely, or parts of it (k steps at a time)
3. [x] Display other trajectories in the background
4. [x] Dynamic display: step by step, with possible to jump n steps at a time
5. [ ] Dynamic display of several trajectories at a time
6. [x] Interaction with keyboard to allow for fast operation
7. [x] Display should be smooth and fast
8. [x] GIS capabilities: additional layers (geometries and raster), zoom, click on features to get more information

#### Should
9. [x] Everything should be also feasible with the mouse
10. [ ] Infolocs should be editable on the fly (using keyboard)

#### Could
11. [ ] Create a pgtraj or ltraj from points.
12. [ ] Additional editing stuff (cutting into bursts, etc.)

#### Won’t
13. Editing the “path” of a trajectory by dragging/moving its relocations. For example as one would edit an object in a drawing program (Inkscape).

### Workflow

Learning from the previous GSoC where I often failed to accurately estimate how long a task takes, particularly if I never did it before, this year I adopted a more relaxed project management. This involved less micro-planning and more prioritization based on the MoSCoW deliverables. Furthermore, I started utilizing GitHub Issues to document features and bugs. This helps in making the project more transparent for future contributors.

We adopted the [Git Flow](http://nvie.com/posts/a-successful-git-branching-model/) branching model.

## The development process

### Research
What we've set out to do in the GSoC 2017 was new not only for me but also for my mentors. We were not certain which technology or framework would serve our goals the best, therefore is was essential to start the project with a **reasearch phase**. The choice of technology has obviously a high impact on the outcome and maintainability of the package, thus it was important to make an informed decision.

During the research phase I read lots of documentation and built small proof-of-concepts in order to figure out how to continue. I put together a simple [requirements matrix](https://docs.google.com/spreadsheets/d/12JKcmBumwTYjSjQzhuwX5I_aeGpwfTZIjcA6sBJTD1w/edit?usp=sharing) in order to maintain objectivity. 

Initially, I was very much in favor of developing a [QGIS](http://qgis.org/en/site/) plugin for `rpostgisLT`, instead of replicating some of QGIS's functionality in R. However, that would have required the user to have QGIS installed and be familiar with its operation. Additionally, QGIS plugins are written in *python* and attracting contributors could be very difficult considering the tiny user base of `rpostgisLT` + `adehabitatLT`.

Therefore, after [several tests](https://github.com/mablab/rpostgisLT/tree/gsoc-2017_poc/test_framework) I set out to build a *Shiny* app with *Leaflet*.

### Development
Providing smooth interaction with the map was one of the main challenges that we expected. Therefore I started working on that from early on. The [traj data model](https://github.com/mablab/rpostgisLT/wiki/The-traj-database-model) defines that a *step* is composed of two *relocations*. If each *step* is modeled by a linestring, then long trajectories can easily contain several hundred-thousand or even million steps. Plotting such amount of linestrings with *Leaflet* is unfeasible, plus querying this amount of data real-time from a *traj* schema can become slow.

To overcome these difficulties I decided to materialize the two PostgreSQL views that are used by the app, `all_burst_summary` and `step_geometry_<pgtraj>` (see the [traj database model](https://github.com/mablab/rpostgisLT/wiki/The-traj-database-model)). Even though this means data duplication, it is necessary for achieving the desired performance, because the materialized views are indexed and the table joins are omitted. To reduce the number of features for Leaflet, I introduced two modes of operation, *Step Mode ON/OFF*. In *Step Mode ON*, each step is an individual linestring which allows to display all step parameters, on the cost of slow operation. In *Step Mode OFF*, the steps are united into a single linestring within the selected *time window*, therefore the amount of linestrings on the map is very low. Therefore in *Step Mode OFF* the display performance is fast but the information display is minimal (only burst and animal name).

## What's next?
You can find the development road map with the remaining features [here](https://github.com/mablab/rpostgisLT/milestone/1).

## What will I take with me
The highlight of this project was the development of a *Shiny* app that allows the interactive exploration of spatial data in a database. I believe developing such applications is a valuable skill to have and I'm glad that I had the chance to learn it.

Secondly, database query optimization played an important role in the project and it is a skill that was on my bucket list since a while.

Unit tests and continuous integration are tools that help a developer write more robust, reliable software therefore I'm happy to have that under my belt. 
